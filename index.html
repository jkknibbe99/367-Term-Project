<!DOCTYPE html>
<html>
    <head>
        <title>367 Term Project</title>
        <link rel="stylesheet" href="main.css">
    </head>
    <body>
        
        <h1>367 Term Project</h1>
        <p>Speed: <span id="boat-speed">0</span></p>
        <p>Boat direction: <span id="boat-turn">0</span></p>

        <!-- Container - this is were the THREE model will be placed -->
        <div id="container"></div>
        
        <!-- Import map -->
        <script type="importmap">
            {
                "imports": {
                    "three" : "./js/three.module.js"
                }
            }
        </script>

        <!-- Boat Driving controls -->
        <script type="text/javascript">
            
            let mode = "view";

            let boat_speed = 0;
            let boat_max_speed = 5;
            let boat_accel = false;
            let boat_turn_deg = 0
            let boat_left_turn = false;
            let boat_right_turn = false;
            let boat_max_turn = 5;

            // update boat speed
            function updateBoatSpeed() {
                if (boat_accel) {
                    if (boat_speed < boat_max_speed) {
                        boat_speed += 0.1;
                    } else {
                        boat_speed = boat_max_speed;
                    }
                } else {
                    if (boat_speed <= 0) {
                        boat_speed = 0;
                    } else {
                        boat_speed -= 0.2;
                    }
                }
                document.getElementById("boat-speed").innerHTML = boat_speed;
            }

            // update boat turning
            function updateBoatTurn() {
                if ((!boat_left_turn && !boat_right_turn) || (boat_left_turn && boat_right_turn)){
                    if (boat_turn_deg < -0.2) {
                        boat_turn_deg += 0.1;
                    } else if (boat_turn_deg > 0.2) {
                        boat_turn_deg -= 0.1;
                    } else {
                        boat_turn_deg = 0;
                    }
                } else if (boat_left_turn) {
                    if (boat_turn_deg >= boat_max_turn) {
                        boat_turn_deg = boat_max_turn;
                    } else {
                        boat_turn_deg += 0.1;
                    }
                } else if (boat_right_turn) {
                    if (boat_turn_deg <= -boat_max_turn) {
                        boat_turn_deg = -boat_max_turn;
                    } else {
                        boat_turn_deg -= 0.1;
                    }
                }
            }

            // keydown listener
            document.addEventListener("keydown", onDocumentKeyDown, false);
            function onDocumentKeyDown(event) {
                var keyCode = event.which;
                if (keyCode == 65) {  // A
                    boat_left_turn = true;
                }
                if (keyCode == 68) {  // D
                    if (mode == "drive"){
                        boat_right_turn = true;
                    } else {
                        mode = "drive";
                        console.log(mode);
                    }
                }
                if (keyCode == 86) {  // V
                    mode = "view";
                    console.log(mode);
                }
                if (keyCode == 87) {  // W
                    boat_accel = true;
                }
                
            };
            // keyup listener
            document.addEventListener("keyup", onDocumentKeyUp, false);
            function onDocumentKeyUp(event) {
                var keyCode = event.which;
                if (keyCode == 65) {  // A
                    boat_left_turn = false;
                }
                if (keyCode == 68) {  // D
                    boat_right_turn = false;
                }
                if (keyCode == 87) {  // W
                    boat_accel = false;
                }
            };
        </script>

        <!-- THREE scene creation script -->
        <script type="module">

            import * as THREE from 'three';  // import Three.js

            import { OrbitControls } from './js/OrbitControls.js';  // import Orbit controls script
            import { GLTFLoader } from './js/GLTFLoader.js';  // import GLTFLoader.js
            import { Water } from './js/Water.js';  // import Water shader
            import { Sky } from './js/Sky.js';  // import Sky shader

            let container, stats;
            let camera, scene, renderer;
            let controls, water, sun, box, boat;

            init();
            animate();

            // Initialize everything
            function init() {

                // Find the container div in the HTML

                container = document.getElementById('container');

                // Create the renderer and add place in the container

                renderer = new THREE.WebGLRenderer();
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.toneMapping = THREE.ACESFilmicToneMapping;
                container.appendChild(renderer.domElement);

                // Create the scene and camera

                scene = new THREE.Scene();

                camera = new THREE.PerspectiveCamera(55, window.innerWidth / window.innerHeight, 1, 20000);
                camera.position.set(30, 30, 100);

                // Sun

                sun = new THREE.Vector3();

                // Water

                const waterGeometry = new THREE.PlaneGeometry(10000, 10000);

                water = new Water(
                    waterGeometry,
                    {
                        textureWidth: 512,
                        textureHeight: 512,
                        waterNormals: new THREE.TextureLoader().load('textures/waternormals.jpg', function (texture) {

                            texture.wrapS = texture.wrapT = THREE.RepeatWrapping;

                        }),
                        sunDirection: new THREE.Vector3(),
                        sunColor: 0xffffff,
                        waterColor: 0x001e0f,
                        distortionScale: 3.7,
                        fog: scene.fog !== undefined
                    }
                );

                water.rotation.x = - Math.PI / 2;

                scene.add(water);

                // Skybox

                const sky = new Sky();
                sky.scale.setScalar(10000);
                scene.add(sky);

                const skyUniforms = sky.material.uniforms;

                skyUniforms['turbidity'].value = 10;
                skyUniforms['rayleigh'].value = 2;
                skyUniforms['mieCoefficient'].value = 0.005;
                skyUniforms['mieDirectionalG'].value = 0.8;

                const parameters = {
                    elevation: 5,
                    azimuth: 180
                };

                const pmremGenerator = new THREE.PMREMGenerator(renderer);

                function updateSun() {

                    const phi = THREE.MathUtils.degToRad(90 - parameters.elevation);
                    const theta = THREE.MathUtils.degToRad(parameters.azimuth);

                    sun.setFromSphericalCoords(1, phi, theta);

                    sky.material.uniforms['sunPosition'].value.copy(sun);
                    water.material.uniforms['sunDirection'].value.copy(sun).normalize();

                    scene.environment = pmremGenerator.fromScene(sky).texture;

                }

                updateSun();

                // Box

                const boxGeometry = new THREE.BoxGeometry(30, 30, 30);
                const boxMaterial = new THREE.MeshStandardMaterial({ roughness: 0 });

                box = new THREE.Mesh(boxGeometry, boxMaterial);
                // scene.add(box);

                // Boat

                var loader = new GLTFLoader();
                loader.load(
                    "./glb/boat.glb",
                    function (gltf) {
                        var scale = 5.6;
                        boat = gltf.scene.children[0];
                        boat.rotation.set(0, -1.5708, 0);
                        boat.scale.set(scale, scale, scale);
                        boat.position.set(0, .1, 0);
                        boat.castShadow = true;
                        scene.add(boat)
                    },
                );
                
                // Orbit controls

                controls = new OrbitControls(camera, renderer.domElement);
                controls.maxPolarAngle = Math.PI * 0.495;
                controls.target.set(0, 10, 0);
                controls.minDistance = 40.0;
                controls.maxDistance = 200.0;
                controls.update();

                // Stats - Currently commented out

                //stats = new Stats();
                //container.appendChild(stats.dom);

                // GUI - Currently commented out

                //const gui = new GUI();

                // const folderSky = gui.addFolder('Sky');
                // folderSky.add(parameters, 'elevation', 0, 90, 0.1).onChange(updateSun);
                // folderSky.add(parameters, 'azimuth', - 180, 180, 0.1).onChange(updateSun);
                // folderSky.open();

                // const waterUniforms = water.material.uniforms;

                // const folderWater = gui.addFolder('Water');
                // folderWater.add(waterUniforms.distortionScale, 'value', 0, 8, 0.1).name('distortionScale');
                // folderWater.add(waterUniforms.size, 'value', 0.1, 10, 0.1).name('size');
                // folderWater.open();

                // Add event listener for browser window resize

                window.addEventListener('resize', onWindowResize);

            }

            // Adjust camera and view window when browser window is resized
            function onWindowResize() {

                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();

                renderer.setSize(window.innerWidth, window.innerHeight);

            }

            // Animate the scene
            function animate() {

                // Callback to animate
                requestAnimationFrame(animate);

                // update camera to drive mode
                if (mode == "drive") {
                    controls.target.set(boat.position.x, boat.position.y, boat.position.z);
                    controls.update();
                }

                // Move boat
                updateBoatSpeed();
                updateBoatTurn();

                // direction vector for movement
                var matrix = new THREE.Matrix4();
                matrix.extractRotation(boat.matrix);
                var direction = new THREE.Vector3(0, 0, 1);
                // direction = matrix.multiplyVector3(direction);

                direction = new THREE.Vector3(0, 0, -1).applyQuaternion(boat.quaternion);

                // scalar to simulate speed
                var vector = direction.multiplyScalar(boat_speed, boat_speed, boat_speed);
                boat.position.x += vector.x;
                boat.position.y += vector.y;
                boat.position.z += vector.z;

                // boat.position.x += boat_speed;
                boat.rotation.y += THREE.MathUtils.degToRad(boat_turn_deg);
                document.getElementById("boat-turn").innerHTML = boat.rotation.y * (180 / Math.PI);

                const time = performance.now() * 0.001;

                // Boat bobbing
                boat.position.y = Math.sin(time) * 0.5 - 0.25;

                // Water movement
                water.material.uniforms['time'].value += 1.0 / 60.0;

                render();
                //stats.update();
            }

            // Render the scene
            function render() {
                renderer.render(scene, camera);
            }

        </script>

    </body>
</html>